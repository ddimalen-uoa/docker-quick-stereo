
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Oculus Rift - PLYs Demo</title>
		<meta charset="utf-8">
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				color: #ffffff;
				padding: 5px;
				font-family:Monospace;
				font-size:13px;
				font-weight: bold;
				text-align:center;
			}
		</style>
	</head>
	<body>

		<div id="info">
			Oculus Rift - PLYs Demo<br /> To see the next 3D model press spacebar.<br />
			(left click: forward, a/s/w/d/r/f: move, h: hide text)
		</div>

		<script src="build/three.min.js"></script>
		<script src="js2/ImprovedNoise.js"></script>
		<script src="js2/effects/OculusRiftEffect.js"></script>
		<script src="js2/controls/FirstPersonControls.js"></script>
		<script src="js2/controls/OculusControls.js"></script>


  		<script src="js2/three.js"></script>

		<script src="js2/loaders/PLYLoader.js"></script>

		<script src="js2/OrbitControls.js"></script>

		<script src="js2/Projector.js"></script>
		<script src="js2/CanvasRenderer.js"></script>

		<script src="js2/Detector.js"></script>
		<script src="js2/stats.min.js"></script>

  		<script src="js2/CanvasTexture.js"></script>
  		<script src="js2/CompressedTexture.js"></script>
  		<script src="js2/CubeTexture.js"></script>
  		<script src="js2/DataTexture.js"></script>
  		<script src="js2/DepthTexture.js"></script>
  		<script src="js2/Texture.js"></script>
  		<script src="js2/VideoTexture.js"></script>

  		<script src="js2/Geometry.js"></script>

  		<script src="js2/UVsDebug.js"></script>
  		<script src="js2/GeometryUtils.js"></script>

  		<input id="z" value=1 style="display:none">
  		<input id="zz" value=1 style="display:none">

		<script>

			var camera, scene, renderer;
			var realcamera;
			var guiVisible = true;

			var mesh, effect, controls, oculuscontrol;

			var meshes = [];
			var meshparent = [];
			var meshparent2 = [];

			var cols = 50;
			var rows = 30;
			var tot = cols * rows;
			var clock = new THREE.Clock();
			var perlin;
			init();
			animate();


			function init() {

				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );

				perlin = new ImprovedNoise();

				camera = new THREE.PerspectiveCamera( 90, window.innerWidth / window.innerHeight, 1, 5000 );

				renderer.setClearColor( 0x000000, 0);

				scene = new THREE.Scene();

				effect = new THREE.OculusRiftEffect( renderer );
				effect.setSize( window.innerWidth, window.innerHeight );

				effect.separation = 2000;
				effect.distortion = 10;
		        effect.fov = 1100;

				controls = new THREE.FirstPersonControls( camera );
				controls.movementSpeed = 10000;
				controls.lookSpeed = 0;
				controls.lookVertical = true;

				oculuscontrol = new THREE.OculusControls( camera );

				document.body.appendChild( renderer.domElement );


				//Light
				var	hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
				hemiLight.color.setHSL( 0.6, 1, 0.6 );
				hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
				hemiLight.position.set( 0, 500, 0 );
				scene.add( hemiLight );


				//Geometry
				function display_ply(){

					var id = document.getElementById("z").value;

					var path_to_PLY = "./data/PLYs/model_"+id+".ply";
					var path_to_texture = "./data/PLYs/left_"+id+".jpg"

					var texture = new Image();

					texture.addEventListener('load', function() { 

						var loader = new THREE.PLYLoader();
						loader.load( path_to_PLY, function ( geometry ) {
							
							//texture
							var width = texture.width-1;
							var height = texture.height-1;

							geometry.faceVertexUvs[0] = [];

							var i=0, x=0, y=0;

							while(i<(width*height*2))
							{
								for(var z = 0; z<height;z++)
								{
									var square=[new THREE.Vector2(y/width, (height-x-1)/height), new THREE.Vector2((y+1)/width, (height-x-1)/height), new THREE.Vector2((y+1)/width, (height-x)/height), new THREE.Vector2(y/width, (height-x)/height)];

									geometry.faceVertexUvs[0][i] = [ square[3], square[0], square[1] ];
									i++; x++;
									geometry.faceVertexUvs[0][i] = [ square[3], square[1], square[2] ];
									i++;
								}
								x=0;
								y++;
							}
									
						 	var material = new THREE.MeshBasicMaterial({map: THREE.ImageUtils.loadTexture(path_to_texture), overdraw: 0.5});
						 	var mesh = new THREE.Mesh(geometry, material);

							mesh.position.x=4;
							mesh.position.y=1.5;
							mesh.position.z=0;

							mesh.rotation.x = Math.PI;
							mesh.rotation.y = 90*Math.PI /180;

							mesh.scale.multiplyScalar( 0.01 );
							scene.add(mesh);

							function remove_mesh(mesh){
								scene.remove(mesh);
							}

							window.addEventListener('keydown',function(e)
							{
								if(e.keyCode == 32) //delete
								{
									
									remove_mesh(mesh);
									
								}
							});

						});

						if(document.getElementById("z").value == 15) //number of PLY files
						{
							document.getElementById("z").value = 1;
						}
						else
						{
							document.getElementById("z").value ++;
						}


					});
					
					texture.src = "./data/PLYs/textureResized_"+id+".png";
				}

				window.addEventListener('load', function(e)
				{
					display_ply();					
				});

				window.addEventListener('keydown', function(e)
				{
					if(e.keyCode == 32) //spacebar
					{
						display_ply();
					}
				});

				window.addEventListener('resize', onWindowResize, false);
				document.addEventListener('keydown', keyPressed, false);

				oculuscontrol.connect();
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				realcamera.aspect = window.innerWidth / window.innerHeight;
				realcamera.updateProjectionMatrix();
				effect.setSize( window.innerWidth, window.innerHeight );
				effect.separation = 200;
				effect.distortion = 10;
		        effect.fov = 1100;
				controls.handleResize();
			}

			function keyPressed(event) {
				if (event.keyCode === 72) { // H
					guiVisible = !guiVisible;
					document.getElementById('info').style.display = guiVisible ? "block" : "none";
				}
			}

			function animate() {
				requestAnimationFrame( animate );

				var t = clock.getElapsedTime();

				controls.update( clock.getDelta() );
				oculuscontrol.update( clock.getDelta() );
				
				effect.render( scene, camera );
			}

		</script>

	</body>
</html>
